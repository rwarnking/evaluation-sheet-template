% OBACHT: with the current implementation the tabularx has a limted amount of supported
% columns (26), having more columns leads to wrong column width
% OBACHT: newlines are not possible since the columns are all equally sized
% and long text would not be usefull anyway
% Use 1-1 and 1a-1 as keys in these cases
%
% TODO: include general info file
% TODO: Fix cellcolor overdrawing lines
% TODO: Add documentation and author
\documentclass{article}

%%%%%%%%%%%%
% Packages %
%%%%%%%%%%%%
\usepackage[utf8]{inputenc}
\usepackage[margin=0.5cm]{geometry}
\usepackage{array, tabularx}
\usepackage[dvipsnames, table]{xcolor}

% For \xintFor and similar
\usepackage{xinttools}
% For \xintifCmp and similar
\usepackage{xintfrac}
% For \forloop
\usepackage{forloop}
%
\usepackage{calc}
% For \pgfmathresult
\usepackage{tikz}

% For loading the .csv files as database
\usepackage{datatool}
% Clip the informations to fit inside the table cells
\usepackage{trimclip}

% Optional
% Used to reduce distance between items in itemize (\setlist)
\usepackage{enumitem}
% Used for displaying code inside the assignments (used for \lstset)
\usepackage{listings}

% TODO: add to install script
% Used for substring and string equality inside the assignment header
% https://tex.stackexchange.com/questions/408896/extract-first-character-allowing-for-extra-grouping
\usepackage{xstring}

% TODO: add to install script
% Used for dashed line
\usepackage{arydshln}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Arguments
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Select or add a course name
\def\coursename{example-coursename-1}

% Select or add a semester
\def\semester{2018-19} % chktex 8
% \def\semester{2018}

% Select or add a sheet (with leading zero)
\def\sheetnumber{01}

% Select a teaching person
\def\tutornumber{1}

% Add a language
\newcommand{\english}{0}
\newcommand{\german}{1}
% Select a language
\def\pdflanguage{\english}

\newcommand{\disable}{0}
\newcommand{\enable}{1}
% Enable or disable different rows of information
\newcommand{\showname}{\enable}
\newcommand{\showstudy}{\disable}
\newcommand{\showpersonid}{\disable}
\newcommand{\showtutorgroupid}{\disable}
\newcommand{\showgroupid}{\enable}
\newcommand{\showdate}{\disable}
% Enable or disable header rows (title, description, points reachable)
\newcommand{\showtitle}{\enable}
\newcommand{\showsubtaskid}{\enable}
\newcommand{\showdesc}{\enable}
\newcommand{\showmaxpoints}{\enable}
% Enable or disable showing points
\newcommand{\showpoints}{\enable}
\newcommand{\showdeadinfo}{\disable}
\newcommand{\showdeadrow}{\enable}
% Enable or disable dashed rows inbetween each participant
\newcommand{\showrowlinesall}{\disable}
% Replaces name with initials if enabled
\newcommand{\shortenfirstname}{\enable}
\newcommand{\shortenlastname}{\disable}
% Replace field of study with its initials
\newcommand{\shortenfieldofstudy}{\enable}

% Define max height of the header
\newlength{\descheaderheight}
\setlength{\descheaderheight}{(120 pt)*\showdesc}

%%%%%%%%%%%%
% Database %
%%%%%%%%%%%%
\DTLsetseparator{;}
\DTLloaddb{participants_db}{\semester_\coursename/participants.csv}
\DTLloaddb{groups_db}{\semester_\coursename/groups.csv}
\DTLloaddb{assignments_db}{\semester_\coursename/sheet_\sheetnumber.csv}
% Only try to load if enabled
\ifthenelse{\equal{\showpoints}{\enable}}%
{%
    \DTLloaddb{points_db}{\semester_\coursename/sheet_\sheetnumber_points.csv}
}{}

% For the particpants_db
\def\personidKey{Matrikelnr}
\def\firstnameKey{Vorname}
\def\lastnameKey{Nachname}
\def\studyfieldKey{Studiengaenge}

% For the groups_db
\def\tutoridKey{tutorid}
\def\groupidKey{groupid}
\def\dateKey{date}
\def\participantsKey{participants}
\def\activeKey{droppedout}

% For the assignments_db
\def\taskidKey{taskid}
\def\titleKey{title}
\def\pointsKey{points}
\def\descriptionKey{description}

%%%%%%%%%%
% Colors %
%%%%%%%%%%
\definecolor{javared}{rgb}{0.6,0,0} % for strings
\definecolor{javagreen}{rgb}{0.25,0.5,0.35} % comments
\definecolor{javapurple}{rgb}{0.5,0,0.35} % keywords
\definecolor{javadocblue}{rgb}{0.25,0.35,0.75} % javadoc
\lstset{
    language=Java,
    basicstyle=\ttfamily,
    keywordstyle=\color{javapurple}\bfseries,
    stringstyle=\color{javared},
    commentstyle=\color{javagreen},
    morecomment=[s][\color{javadocblue}]{/**}{*/},
    numbers=left,
    numberstyle=\tiny\color{black},
    stepnumber=2,
    numbersep=10pt,
    tabsize=4,
    showspaces=false,
    showstringspaces=false,
    %morekeywords={}
}

% Color for cells that should be disabled
\colorlet{disabled}{black!25}
% Color for sumcells with high percentage
\colorlet{exceptional}{green!25}
% Color for sumcells with low percentage
\colorlet{underperformed}{red!25}

%%%%%%%%%%%%
% Commands %
%%%%%%%%%%%%
% Thick Tabular Lines
\makeatletter
\newcommand{\thickhline}{%
    \noalign {\ifnum 0=`}\fi \hrule height 1pt
    \futurelet \reserved@a \@xhline
}
% OBACHT: The arydshln package overrides the behaviour of ! and @
% Furthermore the length of the vrule is changed
% \newcolumntype{;}{@{\vrule width 1pt}}
\newcolumntype{;}{!{\vrule width 1pt}}
\makeatother
% https://tex.stackexchange.com/questions/12703/
\newcolumntype{L}{>{\raggedright\let\newline\\\arraybackslash\hspace{0pt}}X}
\newcolumntype{C}{>{\centering\let\newline\\\arraybackslash\hspace{0pt}}X}

% Test if text is a number
% This is used to differentiate between "1" and "1a"
% https://texfaq.org/FAQ-isitanum
\def\IsPositive#1{%
  TT\fi
  \ifcat_\ifnum0<0#1 _\else A\fi
}

%%%%%%%%%%%%%%%%%%%%%%
% Length definitions %
%%%%%%%%%%%%%%%%%%%%%%
% Remove extra margin left
\setlength{\parindent}{0pt}
\renewcommand{\familydefault}{\sfdefault}
% Remove extra margin in tables
\setlength\tabcolsep{0pt}

% Save font size to be used in multicolumns
\newlength{\thislineheight}
\setlength\thislineheight{\baselineskip}
% Specify the row padding left and right
\newlength{\paddingLR}
\setlength\paddingLR{6pt}
% Specify the row padding top and bottom
\setlength\extrarowheight{2pt}
\setlist{nosep,after=\vspace*{-\baselineskip}}

% The complete header height.
% Uses the selected \descheaderheight and adds the rowheight of each additional enabled header row.
% Used to substract the header height from the height of the page.
\newlength{\headerheight}
\setlength\headerheight{
    \descheaderheight +
    (\thislineheight+\extrarowheight+\arrayrulewidth)*
    (\showtitle+\showsubtaskid+\showmaxpoints)
}

\makeatletter
% Make tablecell width accessible
% https://tex.stackexchange.com/questions/341198/
\newcommand\tablecellwidth{\TX@col@width}
% xstring addition that extracts the leading number from a string.
% Used to get the assignment number from a subtask.
% https://tex.stackexchange.com/questions/35250/
% @param #1 The string
% @returl \Result the macro containing the number
\newcommand*\ExtractLeadingNumber[1]{%
    \IfBeginWith{#1}{ }{\StrBehind{#1}{ }[\temp@@]}{\def\temp@@{#1}}%
    \IfDecimal\temp@@{\def\Result{#1}}{\StrBefore{#1}{\@xs@afterdecimal}[\Result]}%
}
\makeatother

% Clips the input string to fit into a box with the given height.
% The width is also clipped and uses the \linewidth.
% @param #1 the length, default \descheaderheight
% @param #2 the string
\newcommand\clipstring[2][\descheaderheight]{%
    \clipbox{%
        {\dimexpr((\width - (#1))/2)\relax} % chktex 8
        {\dimexpr((\height - \thislineheight)/2 + \extrarowheight)\relax}% chktex 8
    }{%
        #2%
    }%
}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Print Header
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Determine which information rows should be used for the header.
% Each row can be disabled.
\newcommand{\printheader}{%
    % Title row containing filler cells followed by the title of each assignment
    \ifthenelse{\equal{\showtitle}{\enable}}%
    {%
        \printtitlerow%
    }{}%
    % Subtask row containing filler cells followed by the id of each subtask
    \ifthenelse{\equal{\showsubtaskid}{\enable}}%
    {%
        \printsubtaskrow%
    }{}%
    % Description row containing filler cells followed by the description of each assignment
    \ifthenelse{\equal{\showdesc}{\enable}}%
    {%
        \printdescrow%
    }{}%
    % Points row containing filler cells followed by the points of each assignment
    \ifthenelse{\equal{\showmaxpoints}{\enable}}%
    {%
        \printpointsrow%
    }{}%
}

% Title row containing filler cells followed by the title of each assignment
\newcounter{subtasks}
\newcommand{\printtitlerow}{%
    \setcounter{first}{\enable}%
    \printheadercell{\showname}{}{}%
    \printheadercell{\showstudy}{}{}%
    \printheadercell{\showpersonid}{}{}%
    \printheadercell{\showtutorgroupid}{}{}%
    \printheadercell{\showgroupid}{}{}%
    \printheadercell{\showdate}{}{}%
    %
    \DTLforeach*{assignments_db}% database label
    {\curtask=\taskidKey, \curtitle=\titleKey,
        \curpoints=\pointsKey, \curdesc=\descriptionKey}
    {%
        \setcounter{subtasks}{0}%
        \if\IsPositive{\curtask}%
            \DTLforeach*{assignments_db}% database label
            {\tmptask=\taskidKey}{%
                % Get the leading number
                \ExtractLeadingNumber{\tmptask}%
                % Check if the number equals the current assignment
                \IfStrEq{\curtask}{\Result}{%
                    \addtocounter{subtasks}{1}%
                }{}%
            }%
            % Modified version of \checkfirstampersand to cope with no group information
            % % https://comp.text.tex.narkive.com/OwRHjMSV/ifthen-multicolumn-typeout-tabular-problem
            \ifthenelse{\equal{\value{first}}{\enable}}%
            {\setcounter{first}{\disable}\addtocounter{subtasks}{-1}}{}%
            % Check if atleast one subtask is present for the multicolumn
            \xintifGt{\value{subtasks}}{0}%
            {%
                &%
                \multicolumn{\value{subtasks}}{c|}{%
                    \clipstring[%
                        (\tablecellwidth+\tabcolsep+\tabcolsep)*%
                        \value{subtasks}-\tabcolsep-\tabcolsep%
                    ]{\curtitle}%
                }%
            }
        \fi%
    }%
    \checkfirstampersand%
    \\ \hline
}

% Subtask row containing filler cells followed by the id of each subtask
\newcommand{\printsubtaskrow}{%
    \setcounter{first}{\enable}%
    % Add filler cells
    \printheadercell{\showname}{}{}%
    \printheadercell{\showstudy}{}{}%
    \printheadercell{\showpersonid}{}{}%
    \printheadercell{\showtutorgroupid}{}{}%
    \printheadercell{\showgroupid}{}{}%
    \printheadercell{\showdate}{}{}%
    % Iterate all subtasks and add a multicolum for each of them
    \setcounter{subtasks}{0}%
    \DTLforeach*{assignments_db}% database label
    {\curtask=\taskidKey, \curtitle=\titleKey,%
        \curpoints=\pointsKey, \curdesc=\descriptionKey}%
    {%
        % If subtasks is 0 the last multicolumn has ended and the next subtask can be processed
        \xintifEq{\value{subtasks}}{0}%
        {%
            % Count identical subtasks
            \expandafter\DTLsplitstring\expandafter{\curtask}{-}{\beforepartA}{\afterpart}%
            \DTLforeach*{assignments_db}% database label
            {\tmptask=\taskidKey}{%
                \expandafter\DTLsplitstring\expandafter{\tmptask}{-}{\beforepartB}{\afterpart}%
                \IfStrEq{\beforepartA}{\beforepartB}%
                {\addtocounter{subtasks}{1}}{}%
            }%
            % Modified version of \checkfirstampersand to cope with disabled group information
            % https://comp.text.tex.narkive.com/OwRHjMSV/ifthen-multicolumn-typeout-tabular-problem
            \ifthenelse{\equal{\value{first}}{\enable}}%
            {%
                \setcounter{first}{\disable}%
                % Print value first cell
                \clipstring[\tablecellwidth-1pt]{\beforepartA}%
                % Check if an additional multicoulmn is needed
                \xintifGt{\value{subtasks}}{1}%
                {%
                    \addtocounter{subtasks}{-1}%
                    &%
                    \multicolumn{\value{subtasks}}{c|}{%
                        % Redefine beforepartA since it is deleted by the ampersand
                        \expandafter\DTLsplitstring\expandafter{\curtask}{-}{\beforepartA}{\afterpart}%
                        \clipstring[%
                            (\tablecellwidth+\tabcolsep+\tabcolsep)*%
                            \value{subtasks}-\tabcolsep-\tabcolsep%
                        ]{\beforepartA}%
                    }%
                    \addtocounter{subtasks}{1}%
                }{}%
            }{%
                % Default multicolumn when group information is enabled or it is not the first col
                &%
                \multicolumn{\value{subtasks}}{c|}{%
                    % Redefine beforepartA since it is deleted by the ampersand
                    \expandafter\DTLsplitstring\expandafter{\curtask}{-}{\beforepartA}{\afterpart}%
                    \clipstring[%
                        (\tablecellwidth+\tabcolsep+\tabcolsep)*%
                        \value{subtasks}-\tabcolsep-\tabcolsep%
                    ]{\beforepartA}%
                }%
            }%
            \addtocounter{subtasks}{-1}%
        }{%
            \addtocounter{subtasks}{-1}%
        }%
    }%
    \checkfirstampersand%
    \\ \hline
}

% Description row containing filler cells followed by the description of each assignment
\newcommand{\printdescrow}{%
    \setcounter{first}{\enable}%
    \printheadercell{\showname}{}{}%
    \printheadercell{\showstudy}{}{}%
    \printheadercell{\showpersonid}{}{}%
    \printheadercell{\showtutorgroupid}{}{}%
    \printheadercell{\showgroupid}{}{}%
    \printheadercell{\showdate}{}{}%
    %
    \DTLforeach*{assignments_db} % database label
    {\curtask=\taskidKey, \curtitle=\titleKey,
        \curpoints=\pointsKey, \curdesc=\descriptionKey}
    {%
        \checkfirstampersand%
        \rotatebox[origin=c]{90}{\clipstring{\curdesc}}%
    }%
    \checkfirstampersand%
    \xintifEq{\pdflanguage}{\english}%
    {%
        \rotatebox[origin=c]{90}{\clipstring{\textbf{Sum}}}%
    } {%
        \rotatebox[origin=c]{90}{\clipstring{\textbf{Summe}}}%
    }%
    \\ \hline
}

% Points row containing filler cells followed by the points of each assignment
\newcommand{\printpointsrow}{%
    \setcounter{first}{\enable}%
    \printheadercell{\showname}{}{}%
    \printheadercell{\showstudy}{}{}%
    \printheadercell{\showpersonid}{}{}%
    \printheadercell{\showtutorgroupid}{}{}%
    \printheadercell{\showgroupid}{}{}%
    \printheadercell{\showdate}{}{}%
    %
    \DTLforeach*{assignments_db} % database label
    {\curtask=\taskidKey, \curtitle=\titleKey,
        \curpoints=\pointsKey, \curdesc=\descriptionKey}
    {%
        \checkfirstampersand%
        \clipstring[\linewidth-1pt]{\curpoints}%
    }%
    \checkfirstampersand%
    \clipstring[\linewidth-1pt]{\arabic{complsum}}%
    \\ \thickhline%
}

\newcommand{\printheadercell}[3]{%
    \ifthenelse{\equal{#1}{\enable}}%
    {%
        \checkfirstampersand%
        \xintifEq{\pdflanguage}{\english}%
        {%
            \textbf{#2}%
        } {%
            \textbf{#3}%
        }%
    }{}%
}

\newcommand{\checkfirstampersand}{%
    \ifthenelse{\equal{\value{first}}{\enable}}%
    {\setcounter{first}{\disable}}{&}%
}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Add groups
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Prints the task information and the points of the task as two columns.
% Afterwards adds the point information for the task if enabled
% @param the tasktitle
% @param the taskdescription
% @param the points of the task
% @param the task index (row)
% @param the max group index
\newcounter{personnum}
\newcounter{y}
\newcounter{tmpcounter}
\newcounter{itergroups}
\setcounter{itergroups}{0}%
\newcounter{first}
\newcounter{firstgroup}
\setcounter{firstgroup}{\enable}%
\newcommand{\creategroup}{%
    \setcounter{personnum}{1}%
    \addtocounter{itergroups}{1}%
    \setcounter{first}{\enable}%
    %
    \xintFor ##1 in \curparticipants \do {%
        \foreach \n [count=\nn] in \lastsheet {%
            \xintifEq{\nn}{\value{personnum}}%
            {%
                \setcounter{y}{\n}%
            }{}%
        }%
        \addtocounter{personnum}{1}%
        %
        % Set row as dead in the beginning
        \setcounter{deadrow}{\enable}%
        % Check the sheet at which the current member joined or dropped out
        % Check if the member dropped out or joined
        \xintifLt{\value{y}}{0}%
        {%
            % Get absolute value and compare to current sheetnumber
            \xintifGt{\sheetnumber*-1}{\value{y}}%
            % If the member did not yet drop out - the row is alive
            {\setcounter{deadrow}{\disable}}%
            % Otherwise the member is not part of the group for this sheet
            {}% Do not change value since the row counts as dead from the start
        }{%
            % Compare to current sheetnumber
            \xintifLt{\sheetnumber}{\value{y}}%
            % The member is not part of the group for this sheet
            {\setcounter{deadrow}{2}}% Mark row as not yet visible
            % Otherwise the row is alive
            {\setcounter{deadrow}{\disable}}%
        }%
        %
        % Check if dead rows should be visible or removed
        \ifthenelse{\equal{\value{deadrow}}{\enable}}%
        {%
            \ifthenelse{\equal{\showdeadrow}{\enable}}%
            {%
                \printrow{##1}%
            }{}%
        }{%
            % Check if the participant is already active
            \ifthenelse{\equal{\value{deadrow}}{2}}%
            {}{\printrow{##1}}%
        }%
    }%
}

\newcommand{\printrow}[1]{%
    \ifthenelse{\equal{\value{first}}{\enable}}%
    {%
        \ifthenelse{\equal{\value{firstgroup}}{\enable}}%
        {}{\\\hline}%
        \setcounter{first}{\disable}%
        \setcounter{firstgroup}{\disable}%
    }{%
        % If enabled show dashed lines in between all participant rows
        \ifthenelse{\equal{\showrowlinesall}{\enable}}%
        {\\\hdashline}{\\}%
    }%
    %
    \ifthenelse{\equal{\showname}{\enable}}%
    {%
        \isactive{\printnames{#1}}%
        &%
    }{}%
    \ifthenelse{\equal{\showstudy}{\enable}}%
    {%
        \isactive{\printstudy{#1}}%
        &%
    }{}%
    \ifthenelse{\equal{\showpersonid}{\enable}}%
    {%
        \isactive{\printpersonid{#1}}%
        &%
    }{}%
    \ifthenelse{\equal{\showtutorgroupid}{\enable}}%
    {%
        \isactive{\printonce{\printtutorgroupid}}%
        &%
    }{}%
    \ifthenelse{\equal{\showgroupid}{\enable}}%
    {%
        \isactive{\printonce{\printgroupid}}%
        &%
    }{}%
    \ifthenelse{\equal{\showdate}{\enable}}%
    {%
        \isactive{\printonce{\printdate}}%
        &%
    }{}%
    % Add missing ampersands and points if enabled
    \DTLforeach*{assignments_db} % database label
    {\curtask=\taskidKey}%
    {%
        \printonce{\printpoints{\curtask}}%
        &%
    }%
    \printonce{\printpointsum}%
}

% This function is used to print only one value per cell
% Needs personnum to contain 2 for the first participant
% Needs showrowlinesall to be defined
% @param #1 The string to print
\newcommand{\printonce}[1]{%
    \ifthenelse{\equal{\showrowlinesall}{\enable}}%
    {#1}{%
        \ifthenelse{\equal{\value{personnum}}{2}}%
        {#1}{}%
    }%
}

% Check if a participant is active by comparing its entry sheet to the current sheetnumber
% Needs \y to be defined as the entry sheet
% @param content The value that should be printed if the participant is active
\newcommand{\isactive}[1]{%
    % If the person is not yet in the group
    \xintifLt{\sheetnumber}{\value{y}}%
    {}{%
        % If the person left the group
        \xintifLt{\value{y}}{0}%
        {%
            \xintifGt{\sheetnumber*-1}{\value{y}}%
            {#1}{%
                % Allow to hide or show information of dead row
                \ifthenelse{\equal{\showdeadinfo}{\enable}}%
                {#1}{}%
            }%
        }{#1}%
    }%
}

% Iterate and print all participant names given.
% Each in his own line. The participants should be the members of one group.
% Needs \curparticipants to be defined
\newcommand{\printnames}[1]{%
    \DTLgetcolumnindex{\partidcolumn}{participants_db}{\personidKey}%
    % Use this instead of DTLgetrowindex to expand the argument
    \xdtlgetrowindex{\partrow}{participants_db}{\partidcolumn}{#1}% groupindex

    \ifthenelse{\equal{\shortenfirstname}{\enable}}%
    {%
        % Get column index of firstname
        \DTLgetcolumnindex{\namecolumn}{participants_db}{\firstnameKey}%
        \DTLgetvalue{\firstname}%
        {participants_db}%
        {\partrow}%
        {\namecolumn}%
        \expandafter\DTLinitials\expandafter{\firstname{}} %
    }{%
        \DTLfetch{participants_db}{\personidKey}{#1}{\firstnameKey} %
    }%
    %
    \ifthenelse{\equal{\shortenlastname}{\enable}}%
    {%
        % Get column index of lastname
        \DTLgetcolumnindex{\namecolumn}{participants_db}{\lastnameKey}%
        \DTLgetvalue{\lastname}%
        {participants_db}%
        {\partrow}%
        {\namecolumn}%
        \expandafter\DTLinitials\expandafter{\lastname{}}\hspace*{\paddingLR}%
    }{%
        \DTLfetch{participants_db}{\personidKey}{#1}{\lastnameKey}\hspace*{\paddingLR}%
    }%
}

% Iterate and print the study fields of the participants given.
% The participants should be the members of one group.
% Needs \curparticipants to be defined
\newcommand{\printstudy}[1]{%
    \ifthenelse{\equal{\shortenfieldofstudy}{\enable}}%
    {%
        \DTLgetcolumnindex{\partidcolumn}{participants_db}{\personidKey}%
        % Use this instead of DTLgetrowindex to expand the argument
        \xdtlgetrowindex{\partrow}{participants_db}{\partidcolumn}{#1}% groupindex
        % Get column index of lastname
        \DTLgetcolumnindex{\studycolumn}{participants_db}{\studyfieldKey}%
        \DTLgetvalue{\studyfield}%
        {participants_db}%
        {\partrow}%
        {\studycolumn}%
        % Remove potential -of- from the study field string
        \StrSubstitute{\studyfield{}}{of}{}[\temp]%
        \hspace*{\paddingLR}%
        \expandafter\DTLinitials\expandafter{\temp}%
        \hspace*{\paddingLR}%
    }{%
        \hspace*{\paddingLR}%
        \DTLfetch{participants_db}{\personidKey}{#1}{\studyfieldKey}%
        \hspace*{\paddingLR}%
    }%
}

% Iterate and print the identification numbers of the participants given.
% The participants should be the members of one group.
% Needs \curparticipants to be defined
\newcommand{\printpersonid}[1]{%
    \hspace*{\paddingLR}#1\hspace*{\paddingLR}%
}

% Print the tutor group id
\newcommand{\printtutorgroupid}{%
    \hspace*{\paddingLR}\arabic{itergroups}\hspace*{\paddingLR}%
}

% Print the group id
\newcommand{\printgroupid}{%
    \hspace*{\paddingLR}\curgroupid{}\hspace*{\paddingLR}%
}

% Print the day and time for the currently processed slot
\newcommand{\printdate}{%
    \hspace*{\paddingLR}\curdate{}\hspace*{\paddingLR}%
}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Print Points
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Checks if a group has no active members for this sheet.
% If this is the case the column is disabled and colored as disabled.
% The check is done by iterating all members and checking their entry date against the current
% sheet number.
% Expects \lastsheet and \curgroupid to be defined.
% @param taskId The index of the processed task.
\newcounter{deadrow}
\newcounter{deadgroup}
\newcommand{\printpoints}[1]{%
    % If the row is dead then mark it as such, otherwise print the content
    \xintifEq{\value{deadrow}}{\enable}%
    {%
        % Disable the cell
        \cellcolor{disabled}%
    }{%
        % If enabled show points
        \xintifEq{\showpoints}{\enable}%
        {%
            % Get point value of this group for the given task
            \DTLgetcolumnindex{\groupscolumn}{points_db}{\groupidKey}%
            \DTLgetcolumnindex{\assigncolumn}{points_db}{#1}%
            % Use this instead of DTLgetrowindex to expand the argument
            \xdtlgetrowindex{\grouprow}{points_db}{\groupscolumn}{\curgroupid}% groupindex
            \DTLgetvalue{\taskpoints}%
            {points_db}%
            {\grouprow}%
            {\assigncolumn}%
            \clipstring[\linewidth-1pt]{\taskpoints}%
        }{}%
    }%
}

% Calculate the pointsum for the complete sheet (all full assignments) (Is done at startup)
\newcounter{complsum}
\setcounter{complsum}{0}
\DTLforeach*{assignments_db} % database label
{\curtask=\taskidKey, \curpoints=\pointsKey}
{
    \if\IsPositive{\curtask}%
        \addtocounter{complsum}{\curpoints}
    \fi
}

% Counter for the pointsum
\newcounter{pointsum}
% Print the current pointsum and color the cell depending on
% the relation to the max points possible.
% Expects \lastsheet and \curgroupid to be defined.
\newcommand{\printpointsum}{%
    % If the row is dead then mark it as such, otherwise print the content
    \xintifEq{\value{deadrow}}{\enable}%
    {%
        % Disable the cell
        \cellcolor{disabled}%
    }{%
        % If enabled show points
        \xintifEq{\showpoints}{\enable}%
        {%
            % Sum points of group to print them
            \setcounter{pointsum}{0}%
            \DTLforeach*{assignments_db} % database label
            {\curtask=\taskidKey}%
            {%
                % Get the columnindex for this task
                \DTLgetcolumnindex{\taskcolumn}{points_db}{\curtask}%
                \DTLgetcolumnindex{\groupscolumn}{points_db}{\groupidKey}%
                % Use this instead of DTLgetrowindex to expand the argument
                \xdtlgetrowindex{\grouprow}{points_db}{\groupscolumn}{\curgroupid}% groupindex
                \DTLgetvalue{\taskpoints}%
                {points_db}%
                {\grouprow}%
                {\taskcolumn}%
                % Do not sum points of subtask, only full assignments
                \if\IsPositive{\curtask}%
                    \addtocounter{pointsum}{\taskpoints}%
                \fi%
            }%
            %
            % Output point sum
            \clipstring[\linewidth-1pt]{\arabic{pointsum}}%
            % Color sum column for groups with less then half of max points
            \xintifLt{\value{pointsum}}{\value{complsum}*0.5}%
            {\cellcolor{underperformed}}%
            {}%
            % Color sum column for groups with almost max points
            \xintifLt{\value{complsum}*0.95}{\value{pointsum}}%
            {\cellcolor{exceptional}}%
            {}%
        }{}%
    }%
}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Preprocessing
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\newcommand{\getcolumcount}{%
    \newcounter{infocols}
    \setcounter{infocols}{0}

    \ifthenelse{\equal{\showname}{\enable}}%
    {%
        \addtocounter{infocols}{1}
    }{}%
    \ifthenelse{\equal{\showstudy}{\enable}}%
    {%
        \addtocounter{infocols}{1}
    }{}%
    \ifthenelse{\equal{\showpersonid}{\enable}}%
    {%
        \addtocounter{infocols}{1}
    }{}%
    \ifthenelse{\equal{\showtutorgroupid}{\enable}}%
    {%
        \addtocounter{infocols}{1}
    }{}%
    \ifthenelse{\equal{\showgroupid}{\enable}}%
    {%
        \addtocounter{infocols}{1}
    }{}%
    \ifthenelse{\equal{\showdate}{\enable}}%
    {%
        \addtocounter{infocols}{1}
    }{}%
}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Begin document
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\begin{document}
    %%%%%%%%%%%%%%
    % Row counts %
    %%%%%%%%%%%%%%
    \newcounter{currow}
    \newcounter{lowerbound}
    \newcounter{upperbound}

    % Calculate the number maximum number of rows that can fit on one page
    % Use \baselineskip as row height - https://tex.stackexchange.com/questions/119228/
    % Use \textheight as total space available - https://tex.stackexchange.com/questions/101829/
    % Use \extrarowheight as table padding - https://tex.stackexchange.com/questions/31672/
    % Use \arrayrulewidth as rule width - https://tex.stackexchange.com/questions/122956/
    \newcounter{maxrows}
    \pgfmathparse{
        int ((\textheight - \headerheight) / % chktex 8
        (\baselineskip + \extrarowheight + \arrayrulewidth))
    }
    \setcounter{maxrows}{\pgfmathresult}

    \newcounter{numrows}
    \setcounter{numrows}{0}

    % Calculate the total number of groups
    \DTLforeach*{groups_db} % database label
    {\curtutorid=\tutoridKey, \curparticipants=\participantsKey}
    {
        \xintifEq{\curtutorid}{\tutornumber}%
        {%
            % Care this does also count participants that joined the group later on
            \xintFor ##1 in \curparticipants \do {%
                \addtocounter{numrows}{1}
            }
        }{}
    }

    %%%%%%%%%%%%%%%%%
    % Column counts %
    %%%%%%%%%%%%%%%%%
    \newcounter{asigncol}
    \setcounter{asigncol}{0}
    \getcolumcount

    \DTLforeach*{assignments_db} % database label
    {}
    {
        \addtocounter{asigncol}{1}
    }

    %%%%%%%%%%%%%%%
    % Page counts %
    %%%%%%%%%%%%%%%
    % Variable to identify the table currently processed
    \newcounter{pageidx}
    \newcounter{numpages}
    % Precalculate the current page number
    \setcounter{numpages}{\value{numrows}/\value{maxrows}}
    \addtocounter{numpages}{1}

    %%%%%%%%%%%%%
    % Main Loop %
    %%%%%%%%%%%%%
    \setcounter{lowerbound}{0}
    % Iterate all groups and create pages/tables for them
    \forloop{pageidx}{0}{\value{lowerbound} < \value{numrows}}{
        \pgfmathparse{int (\value{lowerbound}+\value{maxrows})}
        \setcounter{upperbound}{\pgfmathresult}
        %
        % Create new left-aligned table (; creates the thickline see \newcolumntype)
        \begin{tabularx}{\textwidth}{
            *{\showname}{l|}
            *{\showstudy}{l|}
            *{\showpersonid}{r|}
            *{\showtutorgroupid}{r|}
            *{\showgroupid}{r|}
            *{\showdate}{r|}
            ;% chktex 26
            *{\value{asigncol}}{C|}C
        }%
            \setcounter{currow}{0}%
            \printheader%
            %
            \DTLforeach*{groups_db}% database label
            {\curgroupid=\groupidKey, \curtutorid=\tutoridKey, \curdate=\dateKey,%
                \curparticipants=\participantsKey, \lastsheet=\activeKey}%
            {%
                \xintFor ##1 in \curparticipants \do {%
                    \addtocounter{currow}{1}%
                }%
                \xintifGt{\value{currow}}{\value{lowerbound}}%
                {%
                    \xintifGt{\value{currow}}{\value{upperbound}}%
                    {\setcounter{firstgroup}{\enable}}%
                    {%
                        \xintifEq{\curtutorid}{\tutornumber}%
                        {%
                            \xintFor ##1 in \curparticipants \do {%
                                \addtocounter{lowerbound}{1}%
                            }%
                            \creategroup%
                        }{}%
                    }%
                }{}%
            }%
        \end{tabularx}
        % If no groups were found print a warning but still show assignments
        \ifnum\value{numrows}=0
            \textcolor{red}{
                \hspace{6.0cm}
                WARNING\@: No groups found!\newline
                \hspace*{6.0cm}
                Please check \semester\_\coursename/groups.csv if it
                really contains groups for tutor \tutornumber.
            }
        \fi
        % Add a clearpage on all pages that are not the last
        \pgfmathparse{\value{pageidx} + 1}%
        \xintifLt{\value{upperbound}}{\value{numrows}}
        {%
            \clearpage
        }{}%
    }

\end{document}
