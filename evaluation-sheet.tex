\documentclass{article}

% TODO remove
\RequirePackage{l3benchmark}
\ExplSyntaxOn
\AtEndDocument { \benchmark_toc: }
\benchmark_tic:
\ExplSyntaxOff

%%%%%%%%%%%%
% Packages %
%%%%%%%%%%%%
\usepackage[utf8]{inputenc}
\usepackage[margin=0.5cm]{geometry}
\usepackage{array, tabularx}
\usepackage[dvipsnames, table]{xcolor}
\usepackage{listings}
%\usepackage{tcolorbox}
\usepackage{enumitem}
\usepackage{pgffor}
\usepackage{xinttools}
\usepackage{xintfrac}
\usepackage{forloop}
\usepackage{calc}
\usepackage{tikz}
%\usepackage{csvsimple}

\usepackage{datatool}

\usepackage{trimclip}

\setlength{\parindent}{0pt}

%%%%%%%%%%
% Colors %
%%%%%%%%%%
\definecolor{javared}{rgb}{0.6,0,0} % for strings
\definecolor{javagreen}{rgb}{0.25,0.5,0.35} % comments
\definecolor{javapurple}{rgb}{0.5,0,0.35} % keywords
\definecolor{javadocblue}{rgb}{0.25,0.35,0.75} % javadoc
\lstset{
    language=Java,
    basicstyle=\ttfamily,
    keywordstyle=\color{javapurple}\bfseries,
    stringstyle=\color{javared},
    commentstyle=\color{javagreen},
    morecomment=[s][\color{javadocblue}]{/**}{*/},
    numbers=left,
    numberstyle=\tiny\color{black},
    stepnumber=2,
    numbersep=10pt,
    tabsize=4,
    showspaces=false,
    showstringspaces=false,
    %morekeywords={}
}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Arguments
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Add a teaching person
\newcommand{\tutorfirst}{0}
\newcommand{\tutorsecond}{1}

% Select a teaching person
\newcommand{\tutor}{\tutorfirst}
% \newcommand{\tutor}{\tutorsecond}

% Select or add a course name
\def\coursename{example-coursename-1}
% \def\coursename{example-coursename-2}

% Select or add a semester
\def\semester{201819}
% \def\semester{2018}

% Select or add a sheet
\def\sheetnumber{01}

% Add a language
\newcommand{\english}{0}
\newcommand{\german}{1}
% Select a language
\def\pdflanguage{\english}

% TODO automate
\newcommand{\columns}{4}
\newcommand{\columnsMO}{3}
\newcommand{\columnsPO}{5}

%%%%%%%%%%%%
% Commands %
%%%%%%%%%%%%
% Thick Tabular Lines
\makeatletter
\newcommand{\thickhline}{%
    \noalign {\ifnum 0=`}\fi \hrule height 1pt
    \futurelet \reserved@a \@xhline
}
\newcolumntype{"}{@{\hskip\tabcolsep\vrule width 1pt\hskip\tabcolsep}}
\makeatother

\edef\innersequence {\xintSeq{1}{\columns}}%
\newcommand{\cells}{%
    \xintFor* ##1 in \innersequence \do {%
        &
    }%
}
\newcommand{\subtask}[2]{\small #1 & #2 \cells}

\def\koma{,}
\newcommand{\klam}[1]{(#1)}
\def\lklam{(}
\def\rklam{)}
\def\elklam{[}
\def\erklam{]}

%%%%%%%%%%%%%%%
% Input files %
%%%%%%%%%%%%%%%
\input{\coursename"_"\semester/sheet_\sheetnumber.tex}

% TODO how to handle empty lists with no participants
% TODO how to mark and process participants that dropped out or changed

\newcommand{\createtask}[3]{
    \textbf{#1} & \textbf{#2} \cells \\ \hline
}

\newcounter{iter}
\newcounter{iterA}
% \pgfmathsetmacro\iterA{int(#1+4)}

%%%%%%%%%%%%%%%
% Database TODO %
%%%%%%%%%%%%%%%
\DTLsetseparator{;}
\DTLloaddb{participants}{\coursename"_"\semester/participants.csv}
\DTLloaddb{groups}{\coursename"_"\semester/groups.csv}

% TODO does not work with ä, ü, ö
\def\personid{Matrikelnr}
\def\firstname{Vorname}
\def\lastname{Nachname}
\def\studyfield{Studiengaenge}

\newcommand\clipstring[2][3cm]{%
    \clipbox{0pt 0pt {\dimexpr\width-#1\relax} 0pt}{#2}%
}

% http://mirrors.ibiblio.org/CTAN/macros/generic/xint/xint.pdf
% https://en.wikibooks.org/wiki/LaTeX/Counters
\newcommand{\printheader}[1]{%
    \pgfmathparse{int(#1 - \columns)}%
    \setcounter{iterA}{0}%

    \xintifEq{\pdflanguage}{\english}%
    {%
        \textbf{Assignment} & \textbf{Pts}
    } {%
        \textbf{Aufgabe} & \textbf{Pkt}
    }
    % Add names by iterating all groups and use the participant-id to
    % get the names for each participant from the participant-database
    \DTLforeach*{groups} % database label
    {\participants=participants} % assignment
    {%
        % Check if the iteration variable is smaller than #1 (upperbound)
        \xintifCmp{#1}{\value{iterA}}{}{}%
        {%
            % Check if the iteration variable is above #1 - 5 (lowerbound)
            \xintifCmp{\value{iterA}}{#1-\columnsPO}{}{}%
            {%
                &
                % \xDTLassignfirstmatch{participants}{\personid}{##1}{\name=\firstname,\points=\lastname}
                % \name \points,\newline%
                % https://tex.stackexchange.com/questions/203277/truncate-text-from-left-to-right
                \foreach \n [count=\ni] in \participants {%
                    \ifnum\ni=1%
                    \else%
                        \newline
                    \fi%
                    \clipstring[\linewidth]{%
                        \DTLfetch{participants}{\personid}{\n}{\firstname}
                        \DTLfetch{participants}{\personid}{\n}{\lastname}%
                    }
                }%
            }%
        }%
        %#1 \arabic{iterA}
        %\ifnum #1>\value{iterA}%
            %& ##1,\newline ##2 #1 \arabic{iterA}%
        %\fi%
        \addtocounter{iterA}{1}%
    }%
    % TODO add missing "and"s
    \\ \hline

    \setcounter{iterA}{0}
    \xintifEq{\pdflanguage}{\english}%
    {%
        \textbf{Field of study} &
    } {%
        \textbf{Studienfach} &
    }
    % Add field of study by iterating all groups and use the participant-id to
    % get the studyfield for each participant from the participant-database
    \DTLforeach*{groups}%
    {\participants=participants}%
    {%
        % Check if the iteration variable is smaller than #1 (upperbound)
        \xintifCmp{#1}{\value{iterA}}{}{}%
        {%
            % Check if the iteration variable is above #1 - 5 (lowerbound)
            \xintifCmp{\value{iterA}}{#1-\columnsPO}{}{}%
            {%
                % TODO does not work if the studyfield is empty
                &
                \foreach \n [count=\ni] in \participants {%
                    \ifnum\ni=1%
                    \else%
                        \newline
                    \fi%
                    \clipstring[\linewidth]{%
                        \DTLfetch{participants}{\personid}{\n}{\studyfield}%
                    }
                }%
            }%
        }%
        \addtocounter{iterA}{1}%
    }%
    \\ \hline

    \setcounter{iterA}{0}
    \xintifEq{\pdflanguage}{\english}%
    {%
        \textbf{Day \& Time} &
    } {%
        \textbf{Tag \& Uhrzeit} &
    }
    % Add dates by iterating all groups and access their day and time
    \DTLforeach*{groups}%
    {\date=date}%
    {%
        % Check if the iteration variable is smaller than #1 (upperbound)
        \xintifCmp{#1}{\value{iterA}}{}{}%
        {%
            % Check if the iteration variable is above #1 - 5 (lowerbound)
            \xintifCmp{\value{iterA}}{#1-\columnsPO}{}{}%
            {%
                & \date{}%
            }%
        }%
        \addtocounter{iterA}{1}%
    }%
    \\ \thickhline
}

\newcommand{\sumrow}{%
    \xintifEq{\pdflanguage}{\english}%
    {%
        \textbf{Sum:} & \cells \\%
    } {%
        \textbf{Summe:} & \cells \\%
    }%
}

\setlength\extrarowheight{2pt}
\setlist{nosep,after=\vspace*{-\baselineskip}}

\renewcommand{\familydefault}{\sfdefault}

%--------------------------------------------------------------

\begin{document}
    \newcounter{allcol}
    \setcounter{allcol}{\columnsMO}

    \DTLforeach*{groups} % database label
    {}
    {
        \addtocounter{allcol}{1}
    }
    %\addtocounter{nbcol}{-1}

    % Variable to identify the table currently processed
    \newcounter{tablenumber}
    \newcounter{max}
    \setcounter{max}{\value{allcol}/\columns}
    \newcounter{upperbound}

    % Iterate all tables
    \forloop{tablenumber}{0}{\value{tablenumber} < \value{max}}{

        \pgfmathparse{int((\value{tablenumber}+1)*\columns)}
        \setcounter{upperbound}{\pgfmathresult}

        \begin{tabularx}{\textwidth}{ X"r"X*{\columnsMO}{|X} }
            \printheader{\arabic{upperbound}}

            \xintForthree #1#2#3 in \taskdata \do
            {
                \createtask{#1}{#2}{#3}
                \xintForpair #4#5 in {#3} \do
                {
                    \subtask{#4}{#5} \\ \hline
                }
                \thickhline
            }
            \sumrow
        \end{tabularx}
    }

\end{document}
