\documentclass{article}

%%%%%%%%%%%%
% Packages %
%%%%%%%%%%%%
\usepackage[utf8]{inputenc}
\usepackage[margin=0.5cm]{geometry}
\usepackage{array, tabularx}
\usepackage[dvipsnames, table]{xcolor}

% For \xintFor and similar
\usepackage{xinttools}
% For \xintifCmp and similar
\usepackage{xintfrac}
% For \forloop
\usepackage{forloop}
%
\usepackage{calc}
% For \pgfmathresult
\usepackage{tikz}

% For loading the .csv files as database
\usepackage{datatool}
% Clip the informations to fit inside the table cells
\usepackage{trimclip}

% Optional
% Used to reduce distance between items in itemize (\setlist)
\usepackage{enumitem}
% Used for displaying code inside the assignments (used for \lstset)
\usepackage{listings}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Arguments
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Select or add a course name
\def\coursename{example-coursename-1}
% \def\coursename{example-coursename-2}

% Select or add a semester
\def\semester{201819}
% \def\semester{2018}

% Select or add a sheet
\def\sheetnumber{01}

% Select a teaching person
\def\tutornumber{1}

% Add a language
\newcommand{\english}{0}
\newcommand{\german}{1}
% Select a language
\def\pdflanguage{\english}

\newcommand{\disable}{0}
\newcommand{\enable}{1}
% Enable or disable different rows of information
\newcommand{\showname}{\enable}
\newcommand{\showstudy}{\enable}
\newcommand{\showpersonid}{\enable}
\newcommand{\showtutorgroupid}{\enable}
\newcommand{\showgroupid}{\enable}
\newcommand{\showdate}{\enable}
% Enable or disable showing points
\newcommand{\showpoints}{\enable}

% TODO automate
\newcommand{\columns}{4}
\newcommand{\columnsMO}{3}
\newcommand{\columnsPO}{5}

%%%%%%%%%%%%
% Database %
%%%%%%%%%%%%
% TODO how to mark and process participants that dropped out or changed
% change dropped out parameter
% 0 means: from this number on the person was member of the group
% 7 means: from this number on the person was member of the group
% -7 means: upto this number the person was member of this group
% This results in dropped out person having negative numbers
% And persons can be added to other groups that are only shown from that sheet on forward
% TODO ignore entries in groups.csv were no members are present
% TODO if header is disabled \thickhline in printheader (235) does not work

\DTLsetseparator{;}
\DTLloaddb{participants}{\semester_\coursename/participants.csv}
\DTLloaddb{groups}{\semester_\coursename/groups.csv}
\DTLloaddb{points}{\semester_\coursename/sheet_\sheetnumber_points.csv}
\DTLloaddb{assignments}{\semester_\coursename/sheet_\sheetnumber.csv}

% TODO does not work with ä, ü, ö
\def\personid{Matrikelnr}
\def\firstname{Vorname}
\def\lastname{Nachname}
\def\studyfield{Studiengaenge}
\def\droppedout{droppedout}

\def\pointsKey{points}

%%%%%%%%%%
% Colors %
%%%%%%%%%%
\definecolor{javared}{rgb}{0.6,0,0} % for strings
\definecolor{javagreen}{rgb}{0.25,0.5,0.35} % comments
\definecolor{javapurple}{rgb}{0.5,0,0.35} % keywords
\definecolor{javadocblue}{rgb}{0.25,0.35,0.75} % javadoc
\lstset{
    language=Java,
    basicstyle=\ttfamily,
    keywordstyle=\color{javapurple}\bfseries,
    stringstyle=\color{javared},
    commentstyle=\color{javagreen},
    morecomment=[s][\color{javadocblue}]{/**}{*/},
    numbers=left,
    numberstyle=\tiny\color{black},
    stepnumber=2,
    numbersep=10pt,
    tabsize=4,
    showspaces=false,
    showstringspaces=false,
    %morekeywords={}
}

% Color for cells that should be disabled
\colorlet{disabled}{black!25}
% Color for sumcells with high percentage
\colorlet{exceptional}{green!25}
% Color for sumcells with low percentage
\colorlet{underperformed}{red!25}

%%%%%%%%%%%%
% Commands %
%%%%%%%%%%%%
% Remove extra margin left
\setlength{\parindent}{0pt}

% Thick Tabular Lines
\makeatletter
\newcommand{\thickhline}{%
    \noalign {\ifnum 0=`}\fi \hrule height 1pt
    \futurelet \reserved@a \@xhline
}
\newcolumntype{;}{@{\hskip\tabcolsep\vrule width 1pt\hskip\tabcolsep}}
\makeatother

% Test if text is a number
% This is used to differentiate between "1" and "1a"
% https://texfaq.org/FAQ-isitanum
\def\IsPositive#1{%
  TT\fi
  \ifcat_\ifnum0<0#1 _\else A\fi
}

\newcommand\clipstring[2][3cm]{%
    \clipbox{0pt 0pt {\dimexpr\width-#1\relax} 0pt}{#2}%
}

\setlength\extrarowheight{2pt}
\setlist{nosep,after=\vspace*{-\baselineskip}}

\renewcommand{\familydefault}{\sfdefault}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Print Header
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Determine which information rows should be used for the header.
% Each row can be disabled.
\newcommand{\printheader}[1]{%
    \ifthenelse{\equal{\showname}{\enable}}
    {%
        \xintifEq{\pdflanguage}{\english}%
        {%
            \textbf{Assignment} & \textbf{Pts}
        } {%
            \textbf{Aufgabe} & \textbf{Pkt}
        }
        \printtablerow{#1}{\printnames} \\ \hline
    }{}

    \ifthenelse{\equal{\showstudy}{\enable}}
    {%
        \xintifEq{\pdflanguage}{\english}%
        {%
            \textbf{Field of study} &
        } {%
            \textbf{Studienfach} &
        }
        \printtablerow{#1}{\printstudy} \\ \hline
    }{}

    \ifthenelse{\equal{\showpersonid}{\enable}}
    {%
        \xintifEq{\pdflanguage}{\english}%
        {%
            \textbf{Person ID} &
        } {%
            \textbf{Matrikelnummer} &
        }
        \printtablerow{#1}{\printpersonid} \\ \hline
    }{}

    \ifthenelse{\equal{\showtutorgroupid}{\enable}}
    {%
        \xintifEq{\pdflanguage}{\english}%
        {%
            \textbf{Tutorgroup ID} &
        } {%
            \textbf{Tutor-Gruppennummer} &
        }
        \printtablerow{#1}{\printtutorgroupid} \\ \hline
    }{}

    \ifthenelse{\equal{\showgroupid}{\enable}}
    {%
        \xintifEq{\pdflanguage}{\english}%
        {%
            \textbf{Group ID} &
        } {%
            \textbf{Gruppennummer} &
        }
        \printtablerow{#1}{\printgroupid} \\ \hline
    }{}

    \ifthenelse{\equal{\showdate}{\enable}}
    {%
        \xintifEq{\pdflanguage}{\english}%
        {%
            \textbf{Day \& Time} &
        } {%
            \textbf{Tag \& Uhrzeit} &
        }
        \printtablerow{#1}{\printdate} \\ \hline
    }{}
    \thickhline
}

\newcounter{itergroups}
% Generic function that prints all values of a row.
% For this all groups are iterated. Furthermore a lower and upper bound
% are defined to print only the groups of the current page.
\newcommand{\printtablerow}[2]{%
    \setcounter{itergroups}{0}
    % Add names by iterating all groups and use the participant-id to
    % get the names for each participant from the participant-database
    \DTLforeach*{groups} % database label
    {\groupid=groupid, \tutorid=tutorid, \date=date,%
        \participants=participants, \lastsheet=droppedout} % assignment
    {%
        \xintifEq{\tutorid}{\tutornumber}%
        {%
            % Check bounds
            % Check if the iteration variable is smaller than #1 (upperbound)
            \xintifCmp{#1}{\value{itergroups}}{}{}%
            {%
                % Check if the iteration variable is above #1 - 5 (lowerbound)
                \xintifCmp{\value{itergroups}}{#1-\columnsPO}{}{}%
                {%
                    &
                    #2
                }%
            }%
            \addtocounter{itergroups}{1}%
        }{}%
    }%
    % Add missing "and"s
    \forloop{itergroups}{\value{itergroups}}{\value{itergroups} < #1}{
        &
    }
}

% Iterate and print all participants names given.
% Each in his own line. The participants should be the members of one group.
\newcommand{\printnames}{%
    \foreach \n [count=\ni] in \participants {%
        % Print a newline first for all but the first element
        \ifnum\ni=1%
        \else%
            \newline
        \fi%
        \clipstring[\linewidth]{%
            \DTLfetch{participants}{\personid}{\n}{\firstname}
            \DTLfetch{participants}{\personid}{\n}{\lastname}%
        }%
    }%
}

% Iterate and print the study fields of the participants given.
% The participants should be the members of one group.
\newcommand{\printstudy}{%
    \foreach \n [count=\ni] in \participants {%
        % Print a newline first for all but the first element
        \ifnum\ni=1%
        \else%
            \newline
        \fi%
        \clipstring[\linewidth]{%
            \DTLfetch{participants}{\personid}{\n}{\studyfield}%
        }%
    }%
}

% Iterate and print the identification numbers of the participants given.
% The participants should be the members of one group.
\newcommand{\printpersonid}{%
    \foreach \n [count=\ni] in \participants {%
        \n{}, %
    }%
}

\newcommand{\printtutorgroupid}{%
    \addtocounter{itergroups}{1}%
    \arabic{itergroups}%
    \addtocounter{itergroups}{-1}%
}

\newcommand{\printgroupid}{%
    \groupid{}%
}

% Print the day and time for the currently processed slot
\newcommand{\printdate}{%
    \date{}%
}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Add task rows
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Add cells to the task rows
% Also add point information for each task if enabled
% @param the tasktitle
% @param the taskdescription
% @param the points of the task
% @param the max group index
% @param the task index (row)
\newcommand{\createtask}[5]{%
    \textbf{#1} #2 & \textbf{#3} \printtablerow{#5}{\printpoints{#4}}%
}
% @param the taskdescription
% @param the points of the task
% @param the max group index
% @param the task index (row)
\newcommand{\createsubtask}[4]{%
    \small #1 & #2 \printtablerow{#4}{\printpoints{#3}}%
}

\newcommand{\printpoints}[1]{%
    % If the group info receives a 0 the group did not yet drop out
    \xintifEq{0}{\lastsheet}
    {
        % If enabled show points
        \xintifEq{\showpoints}{\enable}%
        {%
            % Get point value of this group for the given task
            \DTLfetch{points}{groupid}{\groupid}{#1}
        }{}
    }{
        % If the group info receives a number other than 0
        % the number is tested againt the current sheet
        \xintifLt{\sheetnumber}{\lastsheet}
        {
            % If enabled show points
            \xintifEq{\showpoints}{\enable}%
            {%
                % Get point value of this group for the given task
                \DTLfetch{points}{groupid}{\groupid}{#1}
            }{}
        }{
            \cellcolor{disabled}
        }
    }
}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Print Sum Row
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Calculate the pointsum for the complete sheet (all full assignments)
\newcounter{complsum}
\setcounter{complsum}{0}
\DTLforeach*{assignments} % database label
{\task=taskid, \points=points}
{
    \if\IsPositive{\task}%
        \addtocounter{complsum}{\points}
    \fi
}

% Add the cells to the sum row
% Also add point information if enabled by summing the task points
% @param the max group index
\newcommand{\sumrow}[1]{%
    % Add missing thickline before sumrow
    \\ \thickhline
    \xintifEq{\pdflanguage}{\english}%
    {%
        \textbf{Sum:} &
        \arabic{complsum}
        \printtablerow{#1}{\printpointsum{\groupid}} \\%
    } {%
        \textbf{Summe:} &
        \arabic{complsum}
        \printtablerow{#1}{\printpointsum{\groupid}} \\%
    }%
}

% Counter for the pointsum
\newcounter{pointsum}
% Print the current pointsum and color the cell depending on
% the relation to the max points possible
\newcommand{\printpointsum}[1]{%
    \setcounter{pointsum}{0}
    \DTLforeach*{assignments} % database label
    {\task=taskid}
    {%
        % Get the columnindex for this task
        \DTLgetcolumnindex{\columnidx}{points}{\task}
        \DTLgetvalue{\taskpoints}%
        {points}%
        {#1}% groupindex
        {\columnidx}%
        % Do not sum points of subtask, only full assignments
        \if\IsPositive{\task}%
            \addtocounter{pointsum}{\taskpoints}
        \else
        \fi
    }%
    %
    % If the group info receives a 0 the group did not yet drop out
    \xintifEq{0}{\lastsheet}
    {
        % If enabled show points
        \xintifEq{\showpoints}{\enable}%
        {%
            % Output point sum
            \arabic{pointsum}
            % Color sum column for groups with less then half of max points
            \xintifLt{\value{pointsum}}{\value{complsum}*0.5}%
            {\cellcolor{underperformed}}
            {}
            % Color sum column for groups with almost max points
            \xintifLt{\value{complsum}*0.95}{\value{pointsum}}%
            {\cellcolor{exceptional}}
            {}
        }{}
    }{
        % If the group info receives a number other than 0
        % the number is tested againt the current sheet
        \xintifLt{\sheetnumber}{\lastsheet}
        {
            % If enabled show points
            \xintifEq{\showpoints}{\enable}%
            {%
                % Output point sum
                \arabic{pointsum}
                % Color sum column for groups with less then half of max points
                \xintifLt{\value{pointsum}}{\value{complsum}*0.5}%
                {\cellcolor{underperformed}}
                {}
                % Color sum column for groups with almost max points
                \xintifLt{\value{complsum}*0.95}{\value{pointsum}}%
                {\cellcolor{exceptional}}
                {}
            }{}
        }{
            \cellcolor{disabled}
        }
    }
}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Begin document
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\begin{document}
    \newcounter{allcol}
    \setcounter{allcol}{\columnsMO}

    \DTLforeach*{groups} % database label
    {\tutorid=tutorid}
    {
        \xintifEq{\tutorid}{\tutornumber}%
        {%
            \addtocounter{allcol}{1}
        }{}
    }

    % Variable to identify the table currently processed
    \newcounter{tablenumber}
    \newcounter{max}
    \setcounter{max}{\value{allcol}/\columns}
    \newcounter{upperbound}

    % If no groups were found print a warning but still show assignments
    \ifnum\value{max}=0
        \setcounter{max}{1}
        \textcolor{red}{
            \hspace{6.0cm}
            WARNING\@: No groups found!\newline
            \hspace*{6.0cm}
            Please check \semester\_\coursename/groups.csv if it really contains groups.
        }
        \vspace{-1.0cm}
    \fi

    % Iterate all tables
    \forloop{tablenumber}{0}{\value{tablenumber} < \value{max}}{
        \pgfmathparse{int ((\value{tablenumber}+1)*\columns)}
        \setcounter{upperbound}{\pgfmathresult}

        % Create new table (; is creates the thickline see \newcolumntype)
        \begin{tabularx}{\textwidth}{ X;r;X*{\columnsMO}{|X} }
            \printheader{\arabic{upperbound}}

            \DTLforeach*{assignments} % database label
            {\task=taskid, \title=title, \points=points, \text=description}
            {
                % Create a thickline infront of a full assignment
                % and a normal line infront of subassignments
                \if\IsPositive{\task}%
                    \ifnum\task>1%
                        \\ \thickhline
                    \fi
                    \createtask
                        {\title}
                        {\text}
                        {\points}
                        {\task}
                        {\arabic{upperbound}}
                \else
                    \\ \hline
                    \createsubtask
                        {\text}
                        {\points}
                        {\task}
                        {\arabic{upperbound}}
                \fi
            }
            \sumrow{\arabic{upperbound}}
        \end{tabularx}
        \clearpage
    }

\end{document}
