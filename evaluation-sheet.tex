\documentclass{article}

% TODO remove
\RequirePackage{l3benchmark}
\ExplSyntaxOn
\AtEndDocument { \benchmark_toc: }
\benchmark_tic:
\ExplSyntaxOff

%%%%%%%%%%%%
% Packages %
%%%%%%%%%%%%
\usepackage[utf8]{inputenc}
\usepackage[margin=0.5cm]{geometry}
\usepackage{array, tabularx}
\usepackage[dvipsnames, table]{xcolor}
\usepackage{listings}
%\usepackage{tcolorbox}
\usepackage{enumitem}
\usepackage{pgffor}
\usepackage{xinttools}
\usepackage{xintfrac}
\usepackage{forloop}
\usepackage{calc}
\usepackage{tikz}
%\usepackage{csvsimple}

\usepackage{datatool}

\usepackage{trimclip}

\setlength{\parindent}{0pt}

%%%%%%%%%%
% Colors %
%%%%%%%%%%
\definecolor{javared}{rgb}{0.6,0,0} % for strings
\definecolor{javagreen}{rgb}{0.25,0.5,0.35} % comments
\definecolor{javapurple}{rgb}{0.5,0,0.35} % keywords
\definecolor{javadocblue}{rgb}{0.25,0.35,0.75} % javadoc
\lstset{
    language=Java,
    basicstyle=\ttfamily,
    keywordstyle=\color{javapurple}\bfseries,
    stringstyle=\color{javared},
    commentstyle=\color{javagreen},
    morecomment=[s][\color{javadocblue}]{/**}{*/},
    numbers=left,
    numberstyle=\tiny\color{black},
    stepnumber=2,
    numbersep=10pt,
    tabsize=4,
    showspaces=false,
    showstringspaces=false,
    %morekeywords={}
}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Arguments
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Add a teaching person
\newcommand{\tutorfirst}{0}
\newcommand{\tutorsecond}{1}

% Select a teaching person
\newcommand{\tutor}{\tutorfirst}
% \newcommand{\tutor}{\tutorsecond}

% Select or add a course name
\def\coursename{example-coursename-1}
% \def\coursename{example-coursename-2}

% Select or add a semester
\def\semester{201819}
% \def\semester{2018}

% Select or add a sheet
\def\sheetnumber{01}

% Add a language
\newcommand{\english}{0}
\newcommand{\german}{1}
% Select a language
\def\pdflanguage{\english}

% Enable or disable different rows of information
\newcommand{\disable}{0}
\newcommand{\enable}{1}
\newcommand{\showname}{\enable}
\newcommand{\showstudy}{\enable}
\newcommand{\showdate}{\enable}
% Enable or disable showing points
\newcommand{\showpoints}{\enable}

% TODO automate
\newcommand{\columns}{4}
\newcommand{\columnsMO}{3}
\newcommand{\columnsPO}{5}

%%%%%%%%%%%%%%%
% Database TODO %
%%%%%%%%%%%%%%%
\DTLsetseparator{;}
\DTLloaddb{participants}{\semester"_"\coursename/participants.csv}
\DTLloaddb{groups}{\semester"_"\coursename/groups.csv}
\DTLloaddb{points}{\semester"_"\coursename/sheet_\sheetnumber_points.csv}
\DTLloaddb{assignments}{\semester"_"\coursename/sheet_\sheetnumber.csv}

% TODO does not work with ä, ü, ö
\def\personid{Matrikelnr}
\def\firstname{Vorname}
\def\lastname{Nachname}
\def\studyfield{Studiengaenge}
\def\droppedout{droppedout}

%%%%%%%%%%%%
% Commands %
%%%%%%%%%%%%
% Thick Tabular Lines
\makeatletter
\newcommand{\thickhline}{%
    \noalign {\ifnum 0=`}\fi \hrule height 1pt
    \futurelet \reserved@a \@xhline
}
\newcolumntype{"}{@{\hskip\tabcolsep\vrule width 1pt\hskip\tabcolsep}}
\makeatother

\edef\innersequence {\xintSeq{1}{\columns}}%
\newcommand{\sumcells}{%
    \xintFor* ##1 in \innersequence \do {%
        &
        \DTLgetcolumnindex{\columnidx}{groups}{\droppedout}
        \DTLgetvalue{\tmpcmd}%
        {groups}%
        {##1}%
        {\columnidx}%

        \xintifCmp{\sheetnumber}{\tmpcmd}
        {
            \cellcolor{black!25}
        }{
            \cellcolor{black!25}
        }{
            % \xintifEq{\showpoints}{\enable}%
            % {%
            %     \DTLfetch{points}{groupid}{##1}{#1}
            % }{}
        }
    }%
}

\newcommand{\cells}[2]{%
    \xintFor* ##1 in {\xintSeq{#2-\columnsMO}{#2}} \do {%
        &
        % DTLifnullorempty
        % \DTLifnull{\DTLfetch{groups}{groupid}{##1}{\droppedout}}
        % {true part}
        % {false part}

        \DTLgetcolumnindex{\columnidx}{groups}{\droppedout}
        \DTLgetvalue{\tmpcmd}%
        {groups}%
        {##1}%
        {\columnidx}%

        % \DTLifstring{\DTLfetch{groups}{groupid}{##1}{\droppedout}}
        % {〈string true〉}
        % {false \DTLfetch{groups}{groupid}{##1}{\droppedout}}

        \xintifCmp{\sheetnumber}{\tmpcmd}
        {
            \cellcolor{black!25}
        }{
            \cellcolor{black!25}
        }{
            \xintifEq{\showpoints}{\enable}%
            {%
                \DTLfetch{points}{groupid}{##1}{#1}
            }{}
        }
    }%
}
\newcommand{\createtask}[5]{
    \textbf{#1} #2 & \textbf{#3} \cells{#4}{#5} \\ \hline
}
\newcommand{\createsubtask}[4]{\small #1 & #2 \cells{#3}{#4} \\ \hline}

\def\koma{,}
\newcommand{\klam}[1]{(#1)}
\def\lklam{(}
\def\rklam{)}
\def\elklam{[}
\def\erklam{]}

%%%%%%%%%%%%%%%
% Input files %
%%%%%%%%%%%%%%%

% TODO handle if participant could not be found in participant.csv
% TODO how to mark and process participants that dropped out or changed
% TODO cant deal with empty columns for the points

\newcounter{iter}
\newcounter{iterA}
% \pgfmathsetmacro\iterA{int(#1+4)}

\newcommand\clipstring[2][3cm]{%
    \clipbox{0pt 0pt {\dimexpr\width-#1\relax} 0pt}{#2}%
}

% http://mirrors.ibiblio.org/CTAN/macros/generic/xint/xint.pdf
% https://en.wikibooks.org/wiki/LaTeX/Counters
\newcommand{\printheader}[1]{%
    % TODO delete this?
    \pgfmathparse{int(#1 - \columns)}%
    \setcounter{iterA}{0}%

    \ifthenelse{\equal{\showname}{\enable}}
    {%
        \xintifEq{\pdflanguage}{\english}%
        {%
            \textbf{Assignment} & \textbf{Pts}
        } {%
            \textbf{Aufgabe} & \textbf{Pkt}
        }
        % Add names by iterating all groups and use the participant-id to
        % get the names for each participant from the participant-database
        \DTLforeach*{groups} % database label
        {\participants=participants} % assignment
        {%
            % Check if the iteration variable is smaller than #1 (upperbound)
            \xintifCmp{#1}{\value{iterA}}{}{}%
            {%
                % Check if the iteration variable is above #1 - 5 (lowerbound)
                \xintifCmp{\value{iterA}}{#1-\columnsPO}{}{}%
                {%
                    &
                    % \xDTLassignfirstmatch{participants}{\personid}{##1}{\name=\firstname,\points=\lastname}
                    % \name \points,\newline%
                    % https://tex.stackexchange.com/questions/203277/truncate-text-from-left-to-right
                    \foreach \n [count=\ni] in \participants {%
                        \ifnum\ni=1%
                        \else%
                            \newline
                        \fi%
                        \clipstring[\linewidth]{%
                            \DTLfetch{participants}{\personid}{\n}{\firstname}
                            \DTLfetch{participants}{\personid}{\n}{\lastname}%
                        }
                    }%
                }%
            }%
            %#1 \arabic{iterA}
            %\ifnum #1>\value{iterA}%
                %& ##1,\newline ##2 #1 \arabic{iterA}%
            %\fi%
            \addtocounter{iterA}{1}%
        }%
        % TODO add missing "and"s
        \\ \hline
    }{}

    \ifthenelse{\equal{\showstudy}{\enable}}
    {%
        \setcounter{iterA}{0}
        \xintifEq{\pdflanguage}{\english}%
        {%
            \textbf{Field of study} &
        } {%
            \textbf{Studienfach} &
        }
        % Add field of study by iterating all groups and use the participant-id to
        % get the studyfield for each participant from the participant-database
        \DTLforeach*{groups}%
        {\participants=participants}%
        {%
            % Check if the iteration variable is smaller than #1 (upperbound)
            \xintifCmp{#1}{\value{iterA}}{}{}%
            {%
                % Check if the iteration variable is above #1 - 5 (lowerbound)
                \xintifCmp{\value{iterA}}{#1-\columnsPO}{}{}%
                {%
                    &
                    \foreach \n [count=\ni] in \participants {%
                        \ifnum\ni=1%
                        \else%
                            \newline
                        \fi%
                        \clipstring[\linewidth]{%
                            \DTLfetch{participants}{\personid}{\n}{\studyfield}%
                        }
                    }%
                }%
            }%
            \addtocounter{iterA}{1}%
        }%
        \\ \hline
    }{}

    \ifthenelse{\equal{\showdate}{\enable}}
    {%
        \setcounter{iterA}{0}
        \xintifEq{\pdflanguage}{\english}%
        {%
            \textbf{Day \& Time} &
        } {%
            \textbf{Tag \& Uhrzeit} &
        }
        % Add dates by iterating all groups and access their day and time
        \DTLforeach*{groups}%
        {\date=date}%
        {%
            % Check if the iteration variable is smaller than #1 (upperbound)
            \xintifCmp{#1}{\value{iterA}}{}{}%
            {%
                % Check if the iteration variable is above #1 - 5 (lowerbound)
                \xintifCmp{\value{iterA}}{#1-\columnsPO}{}{}%
                {%
                    & \date{}%
                }%
            }%
            \addtocounter{iterA}{1}%
        }%
        \\ \thickhline
    }{}
}

\newcommand{\sumrow}{%
    \xintifEq{\pdflanguage}{\english}%
    {%
        \textbf{Sum:} & \sumcells \\%
    } {%
        \textbf{Summe:} & \sumcells \\%
    }%
}

\setlength\extrarowheight{2pt}
\setlist{nosep,after=\vspace*{-\baselineskip}}

\renewcommand{\familydefault}{\sfdefault}

%--------------------------------------------------------------

% Test if text is a number
% This is used to differentiate between "1" and "1a"
% https://texfaq.org/FAQ-isitanum
\def\IsPositive#1{%
  TT\fi
  \ifcat_\ifnum0<0#1 _\else A\fi
}

\begin{document}
    \newcounter{allcol}
    \setcounter{allcol}{\columnsMO}

    \DTLforeach*{groups} % database label
    {}
    {
        \addtocounter{allcol}{1}
    }
    %\addtocounter{nbcol}{-1}

    % Variable to identify the table currently processed
    \newcounter{tablenumber}
    \newcounter{max}
    \setcounter{max}{\value{allcol}/\columns}
    \newcounter{upperbound}

    % Iterate all tables
    \forloop{tablenumber}{0}{\value{tablenumber} < \value{max}}{

        \pgfmathparse{int((\value{tablenumber}+1)*\columns)}
        \setcounter{upperbound}{\pgfmathresult}

        \begin{tabularx}{\textwidth}{ X"r"X*{\columnsMO}{|X} }
            \printheader{\arabic{upperbound}}

            \DTLforeach*{assignments} % database label
            {\task=taskid, \title=title, \points=points, \text=description}
            {
                \if\IsPositive{\task}%
                    \createtask
                        {\title}
                        {\text}
                        {\points}
                        {\task}
                        {\arabic{upperbound}}
                \else
                    \createsubtask
                        {\text}
                        {\points}
                        {\task}
                        {\arabic{upperbound}}
                \fi
                % TODO create \thickhline at the end of a task
            }
            \sumrow
        \end{tabularx}
        \clearpage
    }

    % Print error when no groups could be found
    \ifthenelse{\equal{\DTLrowcount{groups}}{0}}
    {%
        WARNING: No groups found!.
        % https://latex.org/forum/viewtopic.php?t=8609
        \PackageError{evaluation-sheet}{The groups.csv does not contain any groups.}{
            Please check your groups.csv if it really contains groups.
        }
    }{}

\end{document}
